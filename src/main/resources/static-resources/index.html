<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akka Haiku</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <div class="container">
        <!-- Top Banner: Title/Message and QR Code Side by Side -->
        <div class="top-banner">
            <div class="banner-left">
                <div class="banner-header">Akka haiku</div>
                <div class="highlight-message">
                    What's on <span style="color: #ffce4a;">your mind</span>?
                    <br/><span style="color: #ffce4a;">Scan here</span> to transform your <span
                        style="color: #ffce4a;">thoughts</span> into a <br/>
                    one-of-a-kind <span style="color: #72d35b;">Haiku</span> and image, <br/>
                    and walk away with a free <span style="color: #72d35b;">Akka t-shirt!</span>
                </div>
            </div>
            <div class="qr-pane">
                <div class="qr-container" id="qrContainer">
                    <div class="no-qr">
                        <span class="loading"></span> Loading QR code...
                    </div>
                </div>
            </div>
        </div>
        <div class="topline"></div>
        <!-- Haiku Tiles Grid -->
        <div id="haikuStreamGrid" class="content-grid"></div>
    </div>
    <script>
        class QrCodeManager {
            constructor() {
                this.qrEventSource = null;
                this.qrContainer = document.getElementById('qrContainer');
                this.currentQrCode = null;
                this.initializeQrStream();
            }
            initializeQrStream() {
                try {
                    this.qrEventSource = new EventSource('/qrcodes');
                    this.qrEventSource.onopen = () => {
                        console.log('QR code stream connected');
                    };
                    this.qrEventSource.onmessage = (event) => {
                        try {
                            const qrCode = JSON.parse(event.data);
                            this.handleQrCode(qrCode);
                        } catch (error) {
                            console.error('Error parsing QR code:', error);
                        }
                    };
                    this.qrEventSource.onerror = (error) => {
                        console.error('QR code EventSource error:', error);
                        this.showQrError();
                        setTimeout(() => {
                            if (this.qrEventSource.readyState === EventSource.CLOSED) {
                                this.initializeQrStream();
                            }
                        }, 5000);
                    };
                } catch (error) {
                    console.error('Failed to initialize QR code EventSource:', error);
                    this.showQrError();
                }
            }
            handleQrCode(qrCode) {
                this.currentQrCode = qrCode;
                this.qrContainer.innerHTML = `
                    <div class="qr-code-display">
                        <a href="${this.escapeHtml('/gateway/' + qrCode.tokenGroupId)}" target="_blank" rel="noopener" class="qr-link">
                            <img src="${this.escapeHtml(qrCode.qrCodeUrl)}" alt="QR Code" class="qr-image" />
                        </a>
                    </div>
                `;
            }
            showQrError() {
                this.qrContainer.innerHTML = `
                    <div class="no-qr error">
                        ‚ùå Failed to load QR code - attempting to reconnect...
                    </div>
                `;
            }
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            destroy() {
                if (this.qrEventSource) {
                    this.qrEventSource.close();
                }
            }
        }
        // --- HaikuStreamManager for /haikus SSE ---
        class HaikuStreamManager {
            constructor() {
                this.haikuGrid = document.getElementById('haikuStreamGrid');
                this.haikuMap = new Map(); // key: id, value: haikuObj
                this.eventSource = null;
                this.connect();
            }
            connect() {
                try {
                    this.eventSource = new EventSource('/haikus');
                    this.eventSource.onopen = () => {
                        // Optionally show connection status
                    };
                    this.eventSource.onmessage = (event) => {
                        try {
                            const haikuObj = JSON.parse(event.data);
                            this.handleHaiku(haikuObj);
                        } catch (e) {
                            console.error('Error parsing haiku:', e);
                        }
                    };
                    this.eventSource.onerror = (err) => {
                        // Optionally show error status
                        setTimeout(() => {
                            if (this.eventSource.readyState === EventSource.CLOSED) {
                                this.connect();
                            }
                        }, 5000);
                    };
                } catch (e) {
                    // Optionally show error status
                }
            }
            getKey(haikuObj) {
                // Use unique id as key
                return haikuObj.id;
            }
            handleHaiku(haikuObj) {
                const key = this.getKey(haikuObj);
                // Only add/update if haiku or image is present
                if (haikuObj.haiku || haikuObj.image) {
                    this.haikuMap.set(key, haikuObj);
                }
                this.render();
            }
            render() {
                this.haikuGrid.innerHTML = '';
                // Only show tiles with haiku or image
                const haikus = Array.from(this.haikuMap.values())
                    .filter(h => h.haiku || h.image)
                    .sort((a, b) => {
                      var aTime = a.generatedAt || 0;
                      var bTime = b.generatedAt || 0;

                      if (aTime > bTime) return -1;
                      else if (aTime < bTime) return 1;
                      else return 0;
                    })
                if (haikus.length === 0) {
                    this.haikuGrid.innerHTML = '<div class="no-content">No haikus generated yet.</div>';
                    return;
                }
                for (const haikuObj of haikus) {
                    const card = document.createElement('div');
                    card.className = 'content-item';
                    // Haiku title
                    let haikuHtml = '';
                    if (haikuObj.haiku && haikuObj.haiku.line1) {
                        haikuHtml += `<div class='haiku'>`;
                        haikuHtml += `<div class='haiku-line'>${this.escapeHtml(haikuObj.haiku.line1)}</div>`;
                        haikuHtml += haikuObj.haiku.line2 ? `<div class='haiku-line'>${this.escapeHtml(haikuObj.haiku.line2)}</div>` : '';
                        haikuHtml += haikuObj.haiku.line3 ? `<div class='haiku-line'>${this.escapeHtml(haikuObj.haiku.line3)}</div>` : '';
                        haikuHtml += `</div>`;
                    } else {
                      if (haikuObj.image && haikuObj.image.url) {
                        haikuHtml += `<div class='haiku'><div class='haiku-line' style='opacity:0.6;'>No haiku generated</div></div>`;
                      } else {
                        haikuHtml += `<div class='haiku'><div class='haiku-line' style='opacity:0.6;'>Generating haiku...</div></div>`;
                      }
                    }
                    // Image
                    let imageHtml = '';
                    if (haikuObj.image && haikuObj.image.url) {
                        imageHtml = `<div class='image-container'><img src='${this.escapeHtml(haikuObj.image.url)}' alt='Generated image' class='generated-image' /></div>`;
                    } else {
                        imageHtml = `<div class='image-container'><div class='no-content' style='opacity:0.6;'>Generating image...</div></div>`;
                    }
                    // Prompt and date
                    let metaHtml = `<div class='content-prompt'><strong>Prompt:</strong> ${this.escapeHtml(haikuObj.prompt || '')}</div>`;
                    const genAt = haikuObj.generatedAt || haikuObj.generateAt;
                    if (genAt) {
                        const date = new Date(genAt).toLocaleString();
                        metaHtml += `<div class='content-timestamp'>Generated at: ${date}</div>`;
                    }
                    card.innerHTML = `${haikuHtml}${imageHtml}${metaHtml}`;
                    this.haikuGrid.appendChild(card);
                }
            }
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            destroy() {
                if (this.eventSource) this.eventSource.close();
            }
        }
        let qrCodeManager;
        document.addEventListener('DOMContentLoaded', () => {
            qrCodeManager = new QrCodeManager();
            haikuStreamManager = new HaikuStreamManager();
        });
        window.addEventListener('beforeunload', () => {
            if (qrCodeManager) {
                qrCodeManager.destroy();
            }
            if (haikuStreamManager) haikuStreamManager.destroy();
        });
    </script>
</body>
</html>