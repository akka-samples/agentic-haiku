<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akka Haiku Generator</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <div class="topline"></div>
    <div class="container">
        <div class="header">
            <h1>Akka Haiku Generator</h1>
            <p>Enter your inspiration and watch AI create beautiful haikus</p>
        </div>

        <div class="input-section">
            <form id="haikuForm" class="input-form">
                <input
                    type="text"
                    id="userInput"
                    class="input-field"
                    placeholder="Enter your inspiration..."
                    required
                    autocomplete="off"
                />
                <button type="submit" class="submit-btn" id="submitBtn">Generate</button>
            </form>
            <div id="status" class="status"></div>
        </div>

        <div id="resultSection" class="content-section" style="display: none;">
            <h2>Generated Haiku</h2>
            <div id="haikuResult"></div>
        </div>
    </div>

    <script>
        let pollingInterval = null;
        let currentHaikuId = null;

        // Generate random UUID v4
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Show status message
        function showStatus(message, isError = false) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status ' + (isError ? 'error' : 'success');
            statusEl.style.display = 'block';
        }

        // Hide status message
        function hideStatus() {
            const statusEl = document.getElementById('status');
            statusEl.style.display = 'none';
        }

        // Stop polling
        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        // Display haiku result
        function displayHaiku(response) {
            const resultSection = document.getElementById('resultSection');
            const haikuResult = document.getElementById('haikuResult');

            let html = '<div class="content-item">';

            // Add haiku if available
            if (response.haiku) {
                html += `<div class="content-prompt">"${response.prompt}"</div>`;
                html += '<div class="haiku">';
                html += `<div class="haiku-line">${response.haiku.line1}</div>`;
                html += `<div class="haiku-line">${response.haiku.line2}</div>`;
                html += `<div class="haiku-line">${response.haiku.line3}</div>`;
                html += '</div>';
            } else {
                html += '<div class="no-content">Generating haiku<span class="blinking-dots">...</span></div>';
            }

            // Add image if available
            if (response.image && response.image.url) {
                html += '<div class="image-container">';
                html += `<img src="${response.image.url}" alt="Generated image" class="generated-image" />`;
                html += '</div>';
            }

            // Add timestamp if available
            if (response.generatedAt) {
                const date = new Date(response.generatedAt);
                html += `<div class="content-timestamp">Generated: ${date.toLocaleString()}</div>`;
            }

            html += '</div>';

            haikuResult.innerHTML = html;
            resultSection.style.display = 'block';
        }

        // Poll for haiku result
        async function pollHaiku(haikuId) {
            try {
                const response = await fetch(`/haikus/${haikuId}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                displayHaiku(data);

                // If haiku is complete (has both haiku and image), stop polling
                if (data.haiku && data.image) {
                    stopPolling();
                    showStatus('Haiku generation complete!', false);
                    document.getElementById('submitBtn').disabled = false;
                }
            } catch (error) {
                console.error('Error polling haiku:', error);
                showStatus('Error fetching haiku: ' + error.message, true);
                stopPolling();
                document.getElementById('submitBtn').disabled = false;
            }
        }

        // Start polling
        function startPolling(haikuId) {
            currentHaikuId = haikuId;

            // Initial poll
            pollHaiku(haikuId);

            // Poll every 2 seconds
            pollingInterval = setInterval(() => {
                pollHaiku(haikuId);
            }, 2000);
        }

        // Handle form submission
        document.getElementById('haikuForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const userInput = document.getElementById('userInput').value.trim();
            if (!userInput) {
                showStatus('Please enter some text', true);
                return;
            }

            // Stop any existing polling
            stopPolling();

            // Generate new UUID for this haiku
            const haikuId = generateUUID();

            // Disable submit button
            document.getElementById('submitBtn').disabled = true;

            // Show loading status
            hideStatus();
            showStatus('Submitting your request...', false);

            try {
                // Submit the haiku generation request
                const response = await fetch(`/haikus/${haikuId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: userInput
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                showStatus('Generating haiku... Please wait.', false);

                // Start polling for results
                startPolling(haikuId);

            } catch (error) {
                console.error('Error submitting haiku:', error);
                showStatus('Error: ' + error.message, true);
                document.getElementById('submitBtn').disabled = false;
            }
        });

        // Clean up polling on page unload
        window.addEventListener('beforeunload', () => {
            stopPolling();
        });
    </script>
</body>
</html>